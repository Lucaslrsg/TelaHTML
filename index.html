<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tela HTML</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <main>
      <section id="section1">
        <table class="tables" id="table1">
          <tr>
            <th>Proposta do Dia</th>
            <th>Contratos Dia</th>
            <th>Total de Leads Dia</th>
            <th>Conversão Dia</th>
            <th>Custo Dia</th>
          </tr>
          <tr>
            <td id="proposta_dia"></td>
            <td id="contratos_dia"></td>
            <td id="total_leads"></td>
            <td id="conversao_dia"></td>
            <td id="custo_dia"></td>
          </tr>
          <tr>
            <th>Adesão Boleto</th>
            <th>Mensalidade Boleto</th>
            <th>Propostas Mês</th>
            <th>Contratos Mês</th>
            <th>Instaladas Mês</th>
          </tr>
          <tr>
            <td id="adesao_boleto"></td>
            <td id="mensalidade_boleto"></td>
            <td id="propostas_mes"></td>
            <td id="contratos_mes"></td>
            <td id="instaladas_mes"></td>
          </tr>
        </table>

        <table class="table" id="tableOrigemVenda">
          <thead>
            <th></th>
            <th>Origem da venda</th>
            <th></th>
            <tr>
              <td><canvas id="barra" width="300" height="120"></canvas></td>
              <td><canvas id="barra1" width="300" height="120"></canvas></td>
              <td><canvas id="barra2" width="300" height="120"></canvas></td>
            </tr> 
        </table>

        <table class="table" id="tableHorario">
          <tr>
            <th>Hora Atual</th>
            <th>12:00 - 15:00</th>
            <th>Diário</th>
          </tr>
          <tr>
            <td><canvas id="line"></canvas></td>
            <td><canvas id="line1"></canvas></td>
            <td><canvas id="line2"></canvas></td>
          </tr>
        </table>

        <section id="section2">
          <table class="table" id="tableSupervisores">
            <tr>
              <th id="usuario_01"></th>
              <th id="usuario_02" style="text-transform: uppercase;"></th>
              <th id="usuario_03"></th>
              <th id="usuario_04"></th>
            </tr>
            <tr>
              <td><canvas class="pizzas" id="pizza"></canvas></td>
              <td><canvas class="pizzas" id="pizza1"></canvas></td>
              <td><canvas class="pizzas" id="pizza2"></canvas></td>
              <td><canvas class="pizzas" id="pizza3"></canvas></td>  
            </tr>
          </table>
          <div>
            <canvas id="myChart"></canvas>
          </div>
        </section>
      </section>
    </main>

    <script>
      //Puxando e tratando os dados do banco
      async function carregarGraficos(){

      $dadosUsuarios = await fetch('http://localhost/api/app/usuarios.php');
      $dadosChamadas = await fetch('http://localhost/api/app/chamadas.php');
      $dadosVendas = await fetch('http://localhost/api/app/vendas.php');
      $dadosFormularios = await fetch('http://localhost/api/app/formularios.php');

      $resUsuarios = await $dadosUsuarios.json();
      $resChamadas = await $dadosChamadas.json();
      $resVendas = await $dadosVendas.json();
      $resFormularios = await $dadosFormularios.json();

      //PEGAR DATA DO SISTEMA
      const date = new Date();
      const hoje = date.toISOString().slice(0, 10);  
      const mes = date.toISOString().slice(0, 7)

      //iniciando variaveis para as tabelas
      let contratosDia = 0;
      let adesaoBoleto = 0;
      let instaladosMes = 0;
      let contratosMes = 0;
      let vendasBoleto = 0.0;
      let vendasTotal = 0.0;
      let propostas =0;
      let chamadasDia = 0;
      let formularios = 0;
      let formulariosPedidos = 0;
      let leadsBlip = 0;
      let televendas = 0;
      let chat = 0;
      

      //completando primeira tabela
      for (let i = 0; i < $resVendas.dados.length; i++) {
        if($resVendas.dados[i].contratos !== null && $resVendas.dados[i].dataContrato !== null){
          if($resVendas.dados[i].dataContrato.slice(0, 10) === hoje){
            contratosDia ++;
          }
          if($resVendas.dados[i].dataContrato.slice(0, 7) === mes){
            contratosMes ++;
          }
        }       

        if($resVendas.dados[i].tipoDePagamento === 'boleto'){
          if($resVendas.dados[i].dataVenda.slice(0, 7) === mes){
            vendasBoleto +=  $resVendas.dados[i].valor;
          }
          if($resVendas.dados[i].dataVenda.slice(0, 10) === hoje){
            adesaoBoleto ++;
          }
        }

        if($resVendas.dados[i].dataVenda !== null && $resVendas.dados[i].dataVenda.slice(0, 7) === mes){
          vendasTotal +=  $resVendas.dados[i].valor;
        }

        if($resVendas.dados[i].dataInstalacao !== null && $resVendas.dados[i].dataInstalacao.slice(0, 7) === mes){
          instaladosMes++;
        }

        if($resVendas.dados[i].dataVenda !== null && $resVendas.dados[i].dataVenda.slice(0, 10) === hoje){
            propostas ++;
        }
        if($resVendas.dados[i].formularios === 1){
          formulariosPedidos++;
        }

        if($resVendas.dados[i].leadsblip === 1){
          leadsBlip ++;
        }

        if($resVendas.dados[i].propostas === null){
          formularios ++;
        }
        
        if($resVendas.dados[i].leadsblip === 0 && $resVendas.dados[i].formularios === 0){
          televendas ++;

        }

        if($resVendas.dados[i].chat === 1){
          chat++;
        }

      }

      for (let i = 0; i < $resChamadas.length; i++) {
        if($resChamadas[i].dataChamada !== null && $resChamadas[i].dataChamada.slice(0, 10) === hoje){
          chamadasDia ++; 
        }        
      }

      let conversaoDia = propostas / chamadasDia;
      let mensalidadeBoleto = (vendasBoleto / vendasTotal) * 100; 
      
      document.getElementById('proposta_dia').textContent = $resVendas.propostas[0].propostas;
      document.getElementById('contratos_dia').textContent = contratosDia;
      document.getElementById('total_leads').textContent = $resVendas.leadsBlip[0].leadsBlip;
      document.getElementById('conversao_dia').textContent = conversaoDia;
      document.getElementById('custo_dia').textContent =  propostas / 2;
      
      document.getElementById('adesao_boleto').textContent = adesaoBoleto;
      document.getElementById('mensalidade_boleto').textContent = mensalidadeBoleto.toFixed(2)+"%";
      document.getElementById('propostas_mes').textContent = $resVendas.propostas[0].propostas * 24;
      document.getElementById('contratos_mes').textContent = contratosMes;
      document.getElementById('instaladas_mes').textContent = instaladosMes;

      document.getElementById('usuario_01').textContent = $resUsuarios[2].nome;
      document.getElementById('usuario_02').textContent = $resUsuarios[1].nome; 
      document.getElementById('usuario_03').textContent = $resUsuarios[3].nome;
      document.getElementById('usuario_04').textContent = $resUsuarios[4].nome;
      
      

      //--------------------Gráficos Pizza-------------------------------
      const boletosPorUsuario = {};
      const contratosPorUsuario = {};
      const propostasPorUsuario = {};

      for (let i = 0; i < $resVendas.dados.length; i++) {
        const venda = $resVendas.dados[i];
        const id = venda.id_usuario;

        if (venda.tipoDePagamento === 'boleto') {
          boletosPorUsuario[id] = (boletosPorUsuario[id] || 0) +1;
        }

        if (venda.contratos !== null) {
          contratosPorUsuario[id] = (contratosPorUsuario[id] || 0) +1;
        }

        if (venda.propostas !== null) {
          propostasPorUsuario[id] = (propostasPorUsuario[id] || 0) +1;
        }
      }

      console.log(boletosPorUsuario);
      console.log(contratosPorUsuario);
      console.log(propostasPorUsuario);


    const pizza = document.getElementById("pizza");
    new Chart(pizza, {
      type: "pie",
      data: {
        labels: ["Contratos", "Proposta", "Mensalidade boleto", "Conversão"],
        datasets: [
          {
            label: $resUsuarios[2].nome,
            data: [contratosPorUsuario[3], propostasPorUsuario[3], boletosPorUsuario[3], 14],
            borderWidth: 1,
          },
        ],
      },
    });
      const pizza1 = document.getElementById("pizza1");
      new Chart(pizza1, {
        type: "pie",
        data: {
          labels: ["Contratos", "Proposta", "Mensalidade boleto", "Conversão"],
          datasets: [
            {
              label: $resUsuarios[1].nome,
              data: [contratosPorUsuario[2], propostasPorUsuario[2], boletosPorUsuario[2], 18.90],
              borderWidth: 1,
            },
          ],
        },
      });
      const pizza2 = document.getElementById("pizza2");
      new Chart(pizza2, {
        type: "pie",
        data: {
          labels: ["Contratos", "Proposta", "Mensalidade boleto", "Conversão"],
          datasets: [
            {
              label: $resUsuarios[3].nome,
              data: [contratosPorUsuario[4], propostasPorUsuario[4], boletosPorUsuario[4], 8.9],
              borderWidth: 1,
            },
          ],
        },  
      });
      const pizza3 = document.getElementById("pizza3");
      new Chart(pizza3, {
        type: "pie",
        data: {
          labels: ["Contratos", "Proposta", "Mensalidade boleto", "Conversão"],
          datasets: [
            {
              label: $resUsuarios[4].nome,
              data: [contratosPorUsuario[5], propostasPorUsuario[5], boletosPorUsuario[5], 16.53],
              borderWidth: 1,
            },
          ],
        },
      });

      
      //-----------------------Gráfico Barra------------------------------

      
      const ctx = document.getElementById("myChart");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Chamadas", "Chat"],
          datasets: [ 
            {
              label: "em Espera",
              data: [chamadasDia, $resChamadas[0].chamadas],
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
    

      const barra = document.getElementById("barra");
      new Chart(barra, {
        type: "bar",  
        data: {
          labels: ["Chamadas", "Pedidos","Conversão"],
          datasets: [ 
            {
              label: "Televendas",
              data: [chamadasDia * 10,televendas , (chamadasDia / televendas) * 100],
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });

      
      const barra1= document.getElementById("barra1");
      new Chart(barra1, {
        type: "bar",
        data: {
          labels: ["Formulários", "Pedidos","Conversão"],
          datasets: [ 
            {
              label: "Formulários",
              data: [formularios, formulariosPedidos, (formularios / formulariosPedidos) * 100],
              borderWidth: 1, 
            },
          ],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
      
      new Chart(barra2, {
        type: "bar",
        data: {
          labels: ["Leads Blip", "Pedidos","Conversão"],
          datasets: [
            {
              label: "Chat",
              data: [leadsBlip, chat, (chat/leadsBlip) * 100],
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });  
      
      //--------------------Gráficos linha----------------------------//
      const line = document.getElementById("line");
      new Chart(line, {
        type: "line",
        data: {
          labels: ["15:00","15:10","15:20"],
          datasets: [ 
            {
              label: "Conversão",
              data: [propostas / chamadasDia,propostas / chamadasDia, propostas / chamadasDia],
              fill: false,
              borderColor: "rgb(0100, 200, 100)",
              tension: 0.1,
            },
            {
              label: "Pedidos",
              data: [0, 3, 4],
              fill: false,
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Meta Pedidos",
              data: [4, 4, 4],
              fill: false,
              borderDash: [5,5],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Leads",
              data: [15,15,17],
              fill: false,
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            },
            {
              label: "Meta Leads",
              data: [16, 16, 16],
              fill: false,
              borderDash: [5,5],
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            }
          ],
        },
      });

      const line1 = document.getElementById("line1");
      new Chart(line1, {
        type: "line",
        data: {
          labels: ["12:00","13:00","14:00","15:00"],
          datasets: [ 
            {
              label: "Conversão",
              data: [20, 25, 50, 33],
              fill: false,
              borderColor: "rgb(0100, 200, 100)",
              tension: 0.1,
            },
            {
              label: "Pedidos",
              data: [0, 3, 4],
              fill: false,
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Meta Pedidos",
              data: [4, 4, 4],
              fill: false,
              borderDash: [5,5],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Leads",
              data: [20, 20,12,21],
              fill: false,
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            },
            {
              label: "Meta Leads",
              data: [20, 20, 18, 19],
              fill: false,
              borderDash: [5,5],
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            }
          ],
        },
      });
      const line2 = document.getElementById("line2");
      new Chart(line2, {
        type: "line",
        data: {
          labels: ["00h","AGORA"],
          datasets: [ 
            {
              label: "Conversão", 
              data: [13,13,13],
              fill: false,
              borderColor: "rgb(0100, 200, 100)",
              tension: 0.1,
            },
            {
              label: "Pedidos",
              data: [56,56,56],
              fill: false,
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Meta Pedidos",
              data: [48,48,48],
              fill: false,
              borderDash: [5,5,5],
              borderColor: "rgb(255, 99, 132)",
              tension: 0.1,
            },
            {
              label: "Leads",
              data: [423,423,423],
              fill: false,
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            },
            {
              label: "Meta Leads",
              data: [356, 356,356],
              fill: false,
              borderDash: [5,5],
              borderColor: "rgb(54, 162, 235)",
              tension: 0.1,
            }
          ],
        },
      });
    }
      window.addEventListener('DOMContentLoaded', carregarGraficos());
    </script>
  </body>
</html>